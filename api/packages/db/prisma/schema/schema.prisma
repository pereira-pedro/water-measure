generator client {
    provider      = "prisma-client-js"
    engineType    = "binary"
    binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model Address {
    id     String @id @default(uuid()) @db.Uuid
    userId String @map("user_id") @db.Uuid

    street        String  @db.VarChar(255)
    street_number String  @db.VarChar(50)
    neighborhood  String? @db.VarChar(64)
    city          String  @db.VarChar(128)
    province      String  @db.VarChar(64)
    postal_code   String  @db.VarChar(16)
    country       String  @default("IT") @db.VarChar(8)

    location Unsupported("geometry(Point, 4326)")? @map("location")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @map("updated_at")

    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    waterMeters WaterMeter[]

    @@index([userId], map: "idx_addresses_user_id")
    @@index([location], map: "idx_addresses_location", type: Gist)
    @@map("addresses")
}

model AuthToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  tokenHash String   @unique @map("token_hash")
  scope     String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_auth_tokens_user_id")
  @@map("auth_tokens")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  fullName  String   @map("full_name")
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  addresses   Address[]
  authTokens  AuthToken[]
  waterMeters WaterMeter[]

  @@map("users")
}

model WaterMeterMeasure {
  id               String   @id @default(uuid()) @db.Uuid
  waterMeterId     String   @db.Uuid @map("water_meter_id")

  collectedCounter BigInt   @map("collected_counter")
  collectedAt      DateTime @map("collected_at")

  waterMeter       WaterMeter @relation(fields: [waterMeterId], references: [id], onDelete: Cascade)

  @@index([waterMeterId], map: "idx_water_meter_measures_water_meter_id")
  @@index([collectedAt], map: "idx_water_meter_measures_collected_at")
  @@map("water_meter_measures")
}

model WaterMeter {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @db.Uuid @map("user_id")
  addressId          String   @db.Uuid @map("address_id")

  registrationNumber String   @map("registration_number")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address            Address  @relation(fields: [addressId], references: [id], onDelete: Cascade)
  measures           WaterMeterMeasure[]

  @@unique([registrationNumber], map: "uq_water_meters_registration_number")
  @@index([userId], map: "idx_water_meters_user_id")
  @@index([addressId], map: "idx_water_meters_address_id")
  @@map("water_meters")
}
